<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ¯é¡Œå›é¡§ - æµ·å·¡ç½²è€ƒè©¦é¡Œåº«</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <button class="back-btn" onclick="goHome()">â† è¿”å›é¦–é </button>
            <h1>âŒ éŒ¯é¡Œå›é¡§</h1>
        </header>

        <div class="mistakes-header" style="text-align: center; margin: 30px 0;">
            <p style="font-size: 18px; color: var(--text-gray);">
                ä½ æœ‰ <strong id="mistakeCount" style="color: var(--error-color); font-size: 24px;">0</strong> é¡Œç­”éŒ¯ã€‚è«‹åœ¨ä¸‹æ–¹è¤‡ç¿’ï¼š
            </p>
        </div>

        <div id="mistakesContainer" style="max-width: 800px; margin: 0 auto;">
            <!-- éŒ¯é¡Œå°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p style="color: var(--text-gray); margin-top: 20px;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div style="text-align: center; margin: 40px 0;">
            <button class="btn btn-secondary" onclick="resetMistakes()">æ¸…é™¤æ‰€æœ‰éŒ¯é¡Œè¨˜éŒ„</button>
            <button class="btn btn-primary" onclick="window.location.href='quiz.html'" style="margin-left: 10px;">
                é‡æ–°ç·´ç¿’
            </button>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/animations.js"></script>
    <script>
        // âœ… å®Œæ•´çš„éŒ¯é¡Œå›é¡§é‚è¼¯
        document.addEventListener('DOMContentLoaded', async function() {
            const storage = new ProgressManager();
            const mistakeIds = storage.getMistakes();
            
            if (mistakeIds.length === 0) {
                document.getElementById('mistakesContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 64px;">ğŸ‰</div>
                        <h3 style="margin-top: 20px;">å¤ªæ£’äº†ï¼æ²’æœ‰éŒ¯é¡Œï¼</h3>
                        <p style="color: var(--text-gray);">ç¹¼çºŒä¿æŒï¼</p>
                    </div>
                `;
                return;
            }
            
            // è¼‰å…¥æ‰€æœ‰é¡Œç›®
            const allQuestions = await loadQuestions();
            
            // âœ… è§£æè¤‡åˆ ID
            function parseQuestionId(compositeId) {
                if (typeof compositeId === 'string') {
                    if (compositeId.startsWith('q')) {
                        const match = compositeId.match(/^q(\d+)_/);
                        return match ? parseInt(match[1]) : null;
                    } else if (compositeId.startsWith('index_')) {
                        return null;
                    }
                }
                return parseInt(compositeId);
            }
            
            // âœ… æ‰¾å‡ºå°æ‡‰çš„é¡Œç›®
            const mistakeQuestions = mistakeIds
                .map(compositeId => {
                    const originalId = parseQuestionId(compositeId);
                    if (originalId === null) {
                        console.warn(`ç„¡æ³•è§£æ ID: ${compositeId}`);
                        return null;
                    }
                    const question = allQuestions.find(q => q.id === originalId);
                    if (!question) {
                        console.warn(`æ‰¾ä¸åˆ°é¡Œç›® ID: ${originalId} (è¤‡åˆID: ${compositeId})`);
                    }
                    return question;
                })
                .filter(q => q !== null);
            
            // é¡¯ç¤ºçµ±è¨ˆ
            const totalMistakes = mistakeIds.length;
            const loadedMistakes = mistakeQuestions.length;
            const failedCount = totalMistakes - loadedMistakes;
            
            document.getElementById('mistakeCount').textContent = totalMistakes;
            
            if (failedCount > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'margin: 20px auto; padding: 15px; background: rgba(251, 188, 4, 0.1); border: 1px solid #FBBC04; border-radius: 12px; max-width: 800px;';
                warningDiv.innerHTML = `
                    <p style="color: #FBBC04; margin: 0; font-size: 14px; text-align: center;">
                        âš ï¸ æœ‰ ${failedCount} é¡Œç„¡æ³•è¼‰å…¥ï¼ˆé¡Œåº«å¯èƒ½å·²æ›´æ–°ï¼‰
                        <button onclick="resetAndRestart()" style="margin-left: 10px; padding: 5px 15px; background: #FBBC04; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            é‡ç½®é€²åº¦
                        </button>
                    </p>
                `;
                document.querySelector('.container').insertBefore(
                    warningDiv, 
                    document.getElementById('mistakesContainer')
                );
            }
            
            // æ¸²æŸ“éŒ¯é¡Œ
            if (mistakeQuestions.length === 0) {
                document.getElementById('mistakesContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 64px;">âš ï¸</div>
                        <h3 style="margin-top: 20px;">ç„¡æ³•è¼‰å…¥éŒ¯é¡Œ</h3>
                        <p style="color: var(--text-gray);">é¡Œåº«å¯èƒ½å·²æ›´æ–°ï¼Œå»ºè­°é‡ç½®é€²åº¦</p>
                        <button class="btn btn-primary" onclick="resetAndRestart()" style="margin-top: 20px;">
                            é‡ç½®é€²åº¦ä¸¦é‡æ–°é–‹å§‹
                        </button>
                    </div>
                `;
                return;
            }
            
            const container = document.getElementById('mistakesContainer');
            container.innerHTML = '';  // æ¸…ç©ºè¼‰å…¥ä¸­çš„æç¤º
            
            mistakeQuestions.forEach((question, index) => {
                const questionCard = createMistakeCard(question, index + 1);
                container.appendChild(questionCard);
            });
        });

        // å»ºç«‹éŒ¯é¡Œå¡ç‰‡
        function createMistakeCard(question, index) {
            const card = document.createElement('div');
            card.className = 'mistake-card';
            card.style.cssText = `
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 16px;
                padding: 25px;
                margin-bottom: 20px;
                transition: transform 0.3s ease;
            `;
            
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-5px)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
            });
            
            const optionsHTML = Object.entries(question.options)
                .map(([key, value]) => {
                    const isCorrect = key === question.correctAnswer;
                    const style = isCorrect 
                        ? 'background: rgba(52, 168, 83, 0.2); border-left: 4px solid #34A853;' 
                        : '';
                    return `
                        <div style="padding: 12px; margin: 8px 0; border-radius: 8px; ${style}">
                            <strong>${key}.</strong> ${value}
                            ${isCorrect ? ' <span style="color: #34A853; font-weight: 600;">âœ… æ­£ç¢ºç­”æ¡ˆ</span>' : ''}
                        </div>
                    `;
                }).join('');
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="background: var(--error-color); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; margin-right: 15px;">
                        éŒ¯é¡Œ ${index}
                    </span>
                    <span style="color: var(--text-gray); font-size: 14px;">ID: ${question.id}</span>
                </div>
                <h3 style="color: var(--white); margin-bottom: 20px; line-height: 1.6; font-size: 18px;">
                    ${question.question}
                </h3>
                ${optionsHTML}
            `;
            
            return card;
        }

        // é‡ç½®ä¸¦é‡æ–°é–‹å§‹
        function resetAndRestart() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰ç­”é¡Œè¨˜éŒ„å’ŒéŒ¯é¡Œã€‚')) {
                const storage = new ProgressManager();
                storage.resetProgress();
                showToast('é€²åº¦å·²é‡ç½®', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // æ¸…é™¤æ‰€æœ‰éŒ¯é¡Œè¨˜éŒ„
        function resetMistakes() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŒ¯é¡Œè¨˜éŒ„å—ï¼Ÿ')) {
                const storage = new ProgressManager();
                const progress = storage.loadProgress();
                if (progress) {
                    progress.mistakes = [];
                    storage.saveProgress(progress);
                    showToast('éŒ¯é¡Œè¨˜éŒ„å·²æ¸…é™¤', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        }

        // è¿”å›é¦–é 
        function goHome() {
            window.location.href = 'index.html';
        }
    </script>

    <style>
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
